/**
 * Metro transformer that automatically wraps _layout.tsx with Vibecode providers
 * Uses simple string transformations to inject wrappers
 */

// Chain to SVG transformer, which then chains to the default babel transformer
// Cant use @expo/metro-config/babel-transformer because it doesnt chain to the SVG transformer.
const upstreamTransformer = require('react-native-svg-transformer/expo')

/**
 * Checks if the file is the root _layout.tsx
 */
function isRootLayout(filename) {
	return (
		(filename.includes('app/_layout.tsx') ||
			filename.includes('app/_layout.js')) &&
		!filename.includes('app/(') // Exclude grouped layouts
	)
}

/**
 * Wraps the layout component with Vibecode providers
 */
function wrapLayoutWithProviders(src) {
	// Find the default export function
	const defaultExportPattern = /export\s+default\s+function\s+(\w+)/
	const match = src.match(defaultExportPattern)

	if (!match) {
		return src // Can't transform, return as-is
	}

	const originalFunctionName = match[1]

	// Remove the default keyword from the original function
	let transformed = src.replace(
		defaultExportPattern,
		`function ${originalFunctionName}`,
	)

	// Add wrapper import at the top
	transformed = `import { VibeDevWrapper } from '@vibecodeapp/sdk';\n${transformed}`

	// Add new default export that wraps the original function
	const newDefaultExport = `
export default function VibeRootLayoutWrapper() {
  return (
    <VibeDevWrapper>
      <${originalFunctionName} />
    </VibeDevWrapper>
  );
}
`

	transformed = `${transformed}\n${newDefaultExport}`

	return transformed
}

async function transform(props) {
	if (isRootLayout(props.filename)) {
		const transformedSrc = wrapLayoutWithProviders(props.src)
		return upstreamTransformer.transform({ ...props, src: transformedSrc })
	}

	return upstreamTransformer.transform(props)
}

module.exports = { transform }
